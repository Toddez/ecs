!function(t){var e={};function s(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=t,s.c=e,s.d=function(t,e,n){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(n,i,function(e){return t[e]}.bind(null,i));return n},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class n{constructor(t,e){this.updateTimeStep=1/t,this.renderTimeStep=1/e,this.updateTime=(new Date).getTime()/1e3,this.renderTime=(new Date).getTime()/1e3,this.startTime=(new Date).getTime()/1e3,this.updates=0,this.frames=0}getTime(){return(new Date).getTime()/1e3-this.startTime}start(){this.onStart&&this.onStart(),window.requestAnimationFrame(()=>{this.tick()})}tick(){const t=(new Date).getTime()/1e3,e=t-this.updateTime,s=t-this.renderTime;e>=this.updateTimeStep&&this.onUpdate&&(this.onUpdate(e),this.updates+=1,this.updateTime=t),s>=this.renderTimeStep&&this.onRender&&(this.onRender(s),this.frames+=1,this.renderTime=t),window.requestAnimationFrame(()=>{this.tick()})}}class i{constructor(t,e){this.x=t,this.y=e}static mulM3(t,e){const s=e[0]*t.x+e[1]*t.y,n=e[3]*t.x+e[4]*t.y;return new i(s,n)}}class r{constructor(t,e,s){this.x=t,this.y=e,this.z=s}}class a{constructor(t,e,s){a.canvases.push(this),this.id=t,this.dimensions=e,this.parent=s,this.margin=new i(0,0),this.createElements(),this.setupWebGL(),this.setup2d(),this.setDimensions(),a.setupInput(this.canvasGl),a.setupInput(this.canvas2d)}createElements(){let t=window.document.body;this.parent&&(t=document.getElementById(this.parent)),this.canvasGl=document.createElement("canvas"),this.canvasGl.id=`${this.id}-gl`,this.canvasGl.style="position: absolute;",t.append(this.canvasGl),this.canvas2d=document.createElement("canvas"),this.canvas2d.id=`${this.id}-2d`,this.canvas2d.style="position: absolute;",t.append(this.canvas2d)}setupWebGL(){this.gl=this.canvasGl.getContext("webgl2",{antialias:!1});this.gl.getExtension("EXT_color_buffer_float")}setup2d(){this.context2d=this.canvas2d.getContext("2d")}setBackground(t){this.background=t}setDimensions(t){t&&(this.dimensions=t),this.canvasGl.width=this.dimensions.x-this.margin.x,this.canvasGl.height=this.dimensions.y-this.margin.y,this.canvas2d.width=this.dimensions.x-this.margin.x,this.canvas2d.height=this.dimensions.y-this.margin.y}setMargin(t){this.margin=t,this.setDimensions()}fullscreen(t){if(this.isFullscreen||(this.originalDimensions=this.dimensions),this.isFullscreen=t,!0===this.isFullscreen){const{body:t}=document,e=document.documentElement,s=Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.offsetHeight);this.dimensions=new i(document.body.clientWidth,s)}else this.originalDimensions&&(this.dimensions=this.originalDimensions);this.setDimensions()}static setupInput(t){t.onmousemove=function(e){const s=t.getBoundingClientRect();a.mousePos=new i(e.clientX-s.left,e.clientY-s.top),a.firstMouseMove&&(a.lastMousePos=a.mousePos,a.firstMouseMove=!1)},t.onmousedown=function(){a.mouseDown=!0},t.onmouseup=function(){a.mouseDown=!1},t.addEventListener("wheel",function(t){a.scrollTotal=new i(a.scrollTotal.x+t.deltaX,a.scrollTotal.y+t.deltaY)},!1)}static setupMouse(){a.mouseDown=!1,a.mousePos=new i(0,0),a.lastMousePos=new i(0,0),a.firstMouseMove=!0}static setupScroll(){a.scrollTotal=new i(0,0),a.lastScroll=new i(0,0)}static setupKeys(){a.keys={},window.addEventListener("keydown",t=>{const e=a.keys[t.which];e&&(e.down=!0,e.onDown&&e.onDown())}),window.addEventListener("keyup",t=>{const e=a.keys[t.which];e&&(e.down=!1,e.onUp&&e.onUp())})}static registerKey(t,e,s){a.keys[t]={down:!1,onDown:e,onUp:s}}static getKeyDown(t){return!!a.keys[t]&&a.keys[t].down}static mouseDelta(){const t=new i(a.mousePos.x-a.lastMousePos.x,a.mousePos.y-a.lastMousePos.y);return a.lastMousePos=a.mousePos,t}static scrollDelta(){const t=new i(a.scrollTotal.x-a.lastScroll.x,a.scrollTotal.y-a.lastScroll.y);return a.lastScroll=a.scrollTotal,t}static windowResizeCallback(){if(a.canvases)for(let t=0;t<a.canvases.length;t+=1)a.canvases[t].isFullscreen&&a.canvases[t].fullscreen(!0)}}a.canvases=[],window.addEventListener("load",()=>{window.addEventListener("resize",a.windowResizeCallback),a.setupMouse(),a.setupKeys(),a.setupScroll()});class o{static identity(t){return t?[t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,t]:o.identity(1)}static translation(t){const e=o.identity(1);return e[12]=t.x,e[13]=t.y,e[14]=t.z,e}static rotation(t,e){const s=o.identity(1),n=t*(Math.PI/180),i=Math.cos(n),r=Math.sin(n),a=1-i,{x:c}=e,{y:l}=e,{z:d}=e;return s[0]=c*a+i,s[1]=l*c*a+d*r,s[2]=l*d*a-l*r,s[4]=c*l*a-d*r,s[5]=l*a+i,s[6]=l*d*a+c*r,s[8]=c*d*a+l*r,s[9]=l*d*a-c*r,s[10]=d*a+i,s}static scaling(t){const e=o.identity(1);return e[0]=t.x,e[5]=t.y,e[10]=t.z,e}static multiply(t,e){const s=new Array(16);for(let n=0;n<4;n+=1)for(let i=0;i<4;i+=1){s[n+4*i]=0;for(let r=0;r<4;r+=1)s[n+4*i]+=t[n+4*r]*e[r+4*i]}return s}static multiplyVector(t,e){return new r(t[0].x*e.x+t[1].x*e.y+t[2].x*e.z+t[3].x,t[4].y*e.x+t[5].y*e.y+t[6].y*e.z+t[7].y,t[8].z*e.x+t[9].z*e.y+t[10].z*e.z+t[11].z)}static projection(t,e,s,n){const i=Math.tan(.5*t*Math.PI/180);return[.5/i,0,0,0,0,.5*e/i,0,0,0,0,-(n+s)/(n-s),-1,0,0,-2*n*s/(n-s),0]}}class c{constructor(t,e,s,n){this.children=[],this.position=t||new r(0,0,0),this.rotation=e||new r(0,0,0),this.scale=s||new r(1,1,1),this.shader=n,this.shaderData={positions:[0],indices:[0]}}}class l{constructor(){this.matrices=[]}push(t){t&&this.matrices.push(t)}pop(t){const e=t||1;for(let t=0;t<e;t+=1)this.matrices.pop()}eval(){let t=o.identity();for(let e=0;e<this.matrices.length;e+=1)t=o.multiply(t,this.matrices[e]);return t}}class d{constructor(){this.transformStack=new l,this.children=[]}render(){this.transformStack=new l;for(let t=0;t<this.children.length;t+=1)this.recursive(this.children[t])}recursive(t){this.transformStack.push(o.translation(t.position)),this.transformStack.push(o.rotation(t.rotation.x,new r(1,0,0))),this.transformStack.push(o.rotation(t.rotation.y,new r(0,1,0))),this.transformStack.push(o.rotation(t.rotation.z,new r(0,0,1))),this.transformStack.push(o.scaling(t.scale)),t.shader?t.shader.data.push({data:t.shaderData,modelView:this.transformStack.eval()}):console.warn("No shader defined for entity");for(let e=0;e<t.children.length;e+=1)this.recursive(t.children[e]);this.transformStack.pop(3)}}class h{constructor(t,e,s,n){this.render=n,this.vertex=e,this.fragment=s;const{gl:i}=h.canvas,r=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))return console.error("Vertex shader error",i.getShaderInfoLog(r)),i.deleteShader(r),null;const a=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(a,s),i.compileShader(a),!i.getShaderParameter(a,i.COMPILE_STATUS))return console.error("Fragment shader error",i.getShaderInfoLog(a)),i.deleteShader(a),null;const o=i.createProgram();i.attachShader(o,r),i.attachShader(o,a),i.linkProgram(o),i.getProgramParameter(o,i.LINK_STATUS)||console.error("Failed to init shader program",i.getProgramInfoLog(o)),this.program=o,this.data=[],h.addShader(t,this)}static addShader(t,e){h.shaderStack[t]=e}static getShader(t){return h.shaderStack[t]}static render(){const{gl:t}=h.canvas;t.viewport(0,0,h.canvas.dimensions.x-h.canvas.margin.x,h.canvas.dimensions.y-h.canvas.margin.y),t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);for(let e=0;e<h.shaderStack.length;e+=1){const s=h.shaderStack[e];s.render?s.render(t,s.program,s.data):console.warn("No render method defined for shader"),s.data=[]}}}h.shaderStack={};class u extends c{constructor(t,e,s){super(t,e,s,h.getShader("pbr"));this.shaderData={positions:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],textureCoordinates:[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],vertexNormals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]}}}window.addEventListener("load",()=>{const t=new n(60,60),e=new a("main",new i(500,500)),s=new d;h.canvas=e;let o,c,l,m=Date.now(),p=Date.now();t.onStart=(()=>{e.fullscreen(!0),l=new u(new r(0,0,0),new r(0,0,0),new r(1,1,1)),s.children.push(l)}),t.onRender=(()=>{m=Date.now(),s.render(),h.render(),e.context2d.clearRect(0,0,e.dimensions.x-e.margin.x,e.dimensions.y-e.margin.y),e.context2d.font="25px Arial",e.context2d.fillStyle="#fff",o=Date.now()-m,e.context2d.fillText(`render time: ${o.toString()}ms`,10,30),e.context2d.fillText(`update time: ${c.toString()}ms`,10,50)}),t.onUpdate=(()=>{p=Date.now(),c=Date.now()-p}),t.start()})}]);